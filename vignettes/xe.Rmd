---
title: "XE and R"
author: "Einar HjÃ¶rleifsson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{xe}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

# Preamble

The xe-package allows seamless connection to the MRI Oracle xe-database via R. Unlike the mar-database the xe-database resides on personal computers and is what the software Hafvog communicates with. The xe-database has at minimum one schema - hafvog. This schema is contains all cruises that are visible in the Hafvog-software. Normally an additional schema is included in the xe-database - fiskar. This contains a copy of most tables that are stored in the MRI Oracle mar-database.

The xe-package is supposed to mimic a proportion of the functional calls that reside in the mar-package (it is likely that functionality of the former will soon be moved into the latter package, i.e. xe will soon become redundant).

# Basic functionality

Once an R session is started the connection to xe is done via:
```{r}
library(tidyverse)
library(ROracle)
library(xe)
con <- connect_xe()
```

To access the data in the hafvog-schema (i.e. the cruises currently visible as "Leidangrar" in the Hafvog-software) one simply does:
```{r}
st.sql <- lesa_stodvar(con, schema = "hafvog")
le.sql <- lesa_lengdir(con, schema = "hafvog")
nu.sql <- lesa_numer(con, schema = "hafvog")
```

If one is interested in working with the data in schema fiskar one simply does:
```{r}
st.sql <- lesa_stodvar(con, schema = "fiskar")
le.sql <- lesa_lengdir(con, schema = "fiskar")
nu.sql <- lesa_numer(con, schema = "fiskar")
```

Take note that in the above the objects st, le and nu are not yet local R-dataframes, just an sql-script that also gives a peek at the first 10 records in the database. To create a local dataframe one can import the data via the collect-function. E.g.

```{r}
st <- st.sql %>% collect(n = Inf)
```

In general things then should work the same as in the mar-package, except that lon and lat in the station-table are still in the DDMMmm-format.


# Working with survey data

Here is an example on how one would get the spring survey data from the database into R.

First we provide and import from schema hafvog:

```{r}
st.sql <- 
  lesa_stodvar(con, "hafvog") %>% 
  filter(synaflokkur == 30)
le <-
  st.sql %>% 
  select(synis_id, ar) %>% 
  left_join(lesa_lengdir(con, "hafvog")) %>% 
  collect(n = Inf)
nu <- 
  st.sql %>% 
  select(synis_id) %>% 
  left_join(lesa_numer(con, "hafvog")) %>% 
  collect(n = Inf)
kv <- 
  st.sql %>% 
  select(synis_id, ar) %>% 
  left_join(lesa_kvarnir(con, "hafvog")) %>% 
  collect(n = Inf)
```

One could repeat this process for data in schema fiskar. This would only be of interest if one wanted to compare historical data with the current data (more on that later).

